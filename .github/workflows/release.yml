name: Build and Release (ARM64)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v1.0.0). Leave empty to auto-increment from latest release.'
        required: false
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine release tag
        id: determine_tag
        run: |
          INPUT_TAG="${{ github.event.inputs.tag }}"
          IS_PRERELEASE="${{ github.event.inputs.prerelease }}"

          if [ -n "$INPUT_TAG" ]; then
            echo "tag=$INPUT_TAG" >> $GITHUB_OUTPUT
          else
            # 最新のリリースタグを取得
            LATEST_TAG=$(gh release list --limit 1 --json tagName --jq '.[0].tagName' 2>/dev/null || echo "")

            if [ -z "$LATEST_TAG" ]; then
              # リリースが存在しない場合
              if [ "$IS_PRERELEASE" = "true" ]; then
                NEW_TAG="v0.0.1-rc1"
              else
                NEW_TAG="v0.0.1"
              fi
            else
              if [ "$IS_PRERELEASE" = "true" ]; then
                # Pre-releaseの場合
                if [[ "$LATEST_TAG" =~ -rc([0-9]+)$ ]]; then
                  # 既に -rc タグが存在する場合、番号をインクリメント
                  RC_NUM="${BASH_REMATCH[1]}"
                  BASE_TAG="${LATEST_TAG%-rc*}"
                  RC_NUM=$((RC_NUM + 1))
                  NEW_TAG="${BASE_TAG}-rc${RC_NUM}"
                else
                  # -rc タグが存在しない場合、バージョンをインクリメントして -rc1 を追加
                  VERSION=${LATEST_TAG#v}
                  MAJOR=$(echo $VERSION | cut -d. -f1)
                  MINOR=$(echo $VERSION | cut -d. -f2)
                  PATCH=$(echo $VERSION | cut -d. -f3)
                  PATCH=$((PATCH + 1))
                  NEW_TAG="v$MAJOR.$MINOR.$PATCH-rc1"
                fi
              else
                # 通常リリースの場合
                if [[ "$LATEST_TAG" =~ -rc[0-9]+$ ]]; then
                  # 最新タグが -rc の場合、-rc を取り除く
                  NEW_TAG="${LATEST_TAG%-rc*}"
                else
                  # 通常のタグの場合、パッチバージョンをインクリメント
                  VERSION=${LATEST_TAG#v}
                  MAJOR=$(echo $VERSION | cut -d. -f1)
                  MINOR=$(echo $VERSION | cut -d. -f2)
                  PATCH=$(echo $VERSION | cut -d. -f3)
                  PATCH=$((PATCH + 1))
                  NEW_TAG="v$MAJOR.$MINOR.$PATCH"
                fi
              fi
            fi

            echo "tag=$NEW_TAG" >> $GITHUB_OUTPUT
          fi

          echo "Using tag: $(cat $GITHUB_OUTPUT | grep tag | cut -d= -f2)"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'

      - name: Build for ARM64 (Linux)
        run: |
          GOOS=linux GOARCH=arm64 go build -o discord-bot-linux-arm64 ./cmd/bot
        env:
          CGO_ENABLED: 0

      - name: Generate SHA256 checksum
        run: |
          sha256sum discord-bot-linux-arm64 > SHA256SUMS.txt
          cat SHA256SUMS.txt

      - name: Set release name
        id: release_name
        run: |
          TAG="${{ steps.determine_tag.outputs.tag }}"
          IS_PRERELEASE="${{ github.event.inputs.prerelease }}"

          if [ "$IS_PRERELEASE" = "true" ]; then
            echo "name=Prerelease $TAG" >> $GITHUB_OUTPUT
          else
            echo "name=Release $TAG" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.determine_tag.outputs.tag }}
          name: ${{ steps.release_name.outputs.name }}
          prerelease: ${{ github.event.inputs.prerelease }}
          files: |
            discord-bot-linux-arm64
            SHA256SUMS.txt
          generate_release_notes: true
